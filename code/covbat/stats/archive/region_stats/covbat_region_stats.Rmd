
```{r}
run_covbat_harmonization <- function(covbat_label,
                                   roi,
                                   stat,
                                   space = "mni", 
                                   method = "reference-penn",
                                   measures_json_path = "/mnt/sauce/littlab/users/mjaskir/structural_tractometry/data/metadata/scalar_labels_to_filenames.json") {

  library(ComBatFamily)
  library(mgcv)
  library(jsonlite)

  # Define inputs/outputs directories
  covbat_inputs_dir = paste0("/mnt/sauce/littlab/users/mjaskir/structural_tractometry/derivatives/covbat/inputs/", covbat_label, "/", space, "/", method)
  covbat_outputs_dir = paste0("/mnt/sauce/littlab/users/mjaskir/structural_tractometry/derivatives/covbat/outputs/", covbat_label, "/", space, "/", method)

  # Make output directory if it doesn't exist
  if (!dir.exists(covbat_outputs_dir)) {
    dir.create(covbat_outputs_dir, recursive = TRUE)
  }

  # Load valid measures from JSON
  valid_measures <- names(fromJSON(measures_json_path))

  # Read and process input files
  print(paste0("Reading input files for ", roi, " ", stat))
  data <- read.csv(file.path(covbat_inputs_dir, paste0(roi, "_", stat, "_data.csv")))
  bat_orig <- read.csv(file.path(covbat_inputs_dir, paste0(roi, "_", stat, "_bat.csv")))
  covar_orig <- read.csv(file.path(covbat_inputs_dir, paste0(roi, "_", stat, "_covar.csv")))
  
  # Process batch and covariate data
  sub <- covar_orig$sub
  bat <- factor(bat_orig$bat, levels = c(0, 1))
  covar <- data.frame(covar_orig)
  covar <- covar[, -which(names(covar) == "sub")]

  if (method == "reference-penn") {

    # Get number of epilepsy patients (n_epilepsy) by looking at the number of rows in covar_orig where group == "penn_epilepsy"
    n_epilepsy <- sum(covar_orig$group == "penn_epilepsy")

    for (measure in valid_measures) {

      # Subset data for current measure
      data_measure <- data[, measure, drop = FALSE]

      # Define formula
      formula <- y ~ s(age, k = 3, fx = TRUE) + sex

      # Run CovBat harmonization
      model <- covfam(
        data = data_measure,
        bat = bat,
        covar = covar,
        mod = gam,
        formula = formula,
        ref.batch = 0 # Reference batch is 0 (Penn)
      )

      # Get harmonized data
      harmonized_data <- model$dat.covbat
      harmonized_data_df <- cbind(
        sub,
        covar,
        bat,
        harmonized_data
      )

      # Make a measure-specific output directory
      measure_dir <- paste0(covbat_outputs_dir, '/', measure)
      if (!dir.exists(measure_dir)) {
        dir.create(measure_dir, recursive = TRUE)
      }

      # Save harmonized data to CSV
      write.csv(
        harmonized_data_df,
        paste0(measure_dir, "/", roi, "_", stat, "_", measure, "_covbat.csv"),
        row.names = FALSE,
        quote = FALSE
      )
    }
  }
}

covbat_label <- "region_stats"
stats <- c("mean", "median")
space <- "mni"
method <- "reference-penn"

covbat_inputs_dir <- paste0("/mnt/sauce/littlab/users/mjaskir/structural_tractometry/derivatives/covbat/inputs/", covbat_label, "/", space, "/", method)

# Get list of ROIs from input directory
roi_files <- list.files(covbat_inputs_dir)
rois <- unique(sapply(roi_files, function(roi) {
  gsub("(_mean|_median).*", "", roi)
}))

for (roi in rois) {
  for (stat in stats) {
    print(paste0("Running CovBat for ", roi, " ", stat))
    run_covbat_harmonization(covbat_label, roi, stat)
  }
}
```